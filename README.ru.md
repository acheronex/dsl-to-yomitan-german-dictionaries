# Конвертер DSL to Yomitan для немецких словарей

Python-инструмент для конвертации немецких словарей DSL (ABBYY Lingvo) в формат Yomitan.

[README in English](./README.md)

---

## Описание

Этот конвертер преобразует немецкие словари DSL (используемые в GoldenDict, ABBYY Lingvo) в ZIP-архивы, совместимые с Yomitan. Оптимизирован для немецких словарей, таких как Duden, Langenscheidt и Universal, но работает с любыми словарями в формате DSL.

## Возможности

- **Парсинг DSL** — чтение .dsl файлов в кодировке UTF-16 с извлечением заголовков
- **Конвертация тегов** — преобразование тегов DSL (жирный, курсив, цвета, отступы, переводы) в JSON структурированный контент Yomitan
- **Поддержка нескольких словарей** — работает с Duden, Langenscheidt, Universal и другими немецкими словарями DSL
- **Автоматическое определение языка** — определяет De-De, De-Ru, Ru-De из заголовков словаря
- **Поддержка тёмной темы** — CSS использует `prefers-color-scheme` для автоматического переключения темы
- **Разбиение термбанка** — разделяет большие словари на части по 10 000 статей
- **Модульные тесты** — покрытие тестами (pytest) для парсера, конвертера и упаковщика

## Установка

```bash
# Клонировать репозиторий
git clone https://github.com/acheronex/dsl-to-yomitan-german-dictionaries.git
cd dsl-to-yomitan-german-dictionaries

# Создать виртуальное окружение
python3 -m venv venv

# Активировать виртуальное окружение
# Linux/Mac:
source venv/bin/activate
# Windows:
venv\Scripts\activate

# Установить зависимости
pip install -r requirements.txt
```

## Требования

- Python 3.10+
- pytest (для тестирования)
- chardet (для определения кодировки)
- ruff (для проверки качества кода)

## Использование

### Базовое использование

```bash
python main.py --input "путь/к/папке/словаря" --output "out/"
```

### Пример: конвертация словаря Langenscheidt

```bash
python main.py \
  --input "LINGVO X3 DEUTSCH AS FORIEGN BY LANGENS DE_DE_DSL" \
  --output out/
```

Вывод:
```
INFO: Processing De-De-Langens_gwdaf.dsl...
INFO: Successfully created out/De-De-Langens_gwdaf.zip with 32687 entries.
```

### Запуск тестов

```bash
# Запустить все тесты
pytest

# Запустить конкретный файл тестов
pytest tests/test_parser.py

# Запустить конкретный тест
pytest tests/test_parser.py::test_bold_tag
```

### Качество кода

```bash
# Проверка линтером
ruff check .

# Автоматическое исправление ошибок линтера
ruff check . --fix

# Форматирование кода
ruff format .
```

## Формат входных данных

Инструмент ожидает папку с файлами `.dsl`:

```
ваша-папка-со-словарём/
├── ИмяСловаря.dsl        # Основной файл словаря
├── ИмяСловаря.ann        # Опционально: файл аннотаций
├── ИмяСловаря_abrv.dsl   # Опционально: файл сокращений
└── *.tif, *.wav         # Опционально: медиафайлы
```

### Поддерживаемые теги DSL

| Тег | Описание |
|-----|----------|
| `[b]...[/b]` | Жирный |
| `[i]...[/i]` | Курсив |
| `[u]...[/u]` | Подчёркнутый |
| `[sup]...[/sup]` | Надстрочный |
| `[sub]...[/sub]` | Подстрочный |
| `[c]...[/c]` | Цветной текст |
| `[m1]`, `[m2]`, `[m3]` | Уровни отступов |
| `[trn]...[/trn]` | Перевод |
| `[ref]...[/ref]` | Перекрёстная ссылка |
| `[ex]...[/ex]` | Пример предложения |
| `[p]...[/p]` | Часть речи / сокращение |
| `[com]...[/com]` | Комментарий |
| `[s]...[/s]` | Медиа (изображения/звук) |
| `[t]...[/t]` | Транскрипция IPA |
| `[lang id=N]...[/lang]` | Языковая зона |

## Формат выходных данных

Инструмент создаёт ZIP-архив, совместимый с Yomitan:

```
выходная-папка/
└── ИмяСловаря.zip
    ├── index.json          # Метаданные словаря
    ├── term_bank_1.json    # Первые 10 000 статей
    ├── term_bank_2.json    # Следующие 10 000 статей (если нужно)
    └── styles.css          # Стили словаря
```

## Где взять словари DSL

Инструмент работает с существующими словарями в формате DSL. Найти их можно:

- **Форумы GoldenDict** — сообщество и ресурсы
- **Ru-Board** — русские форумы о софте
- **Торренты** — различные коллекции словарей
- **Ваша установка GoldenDict/Lingvo**

*Внимание: словари DSL обычно являются проприетарными и требуют соответствующего лицензирования. Пожалуйста, соблюдайте авторские права в вашей стране.*

## Поддерживаемые словари

Протестировано и работает с:

- **Langenscheidt** — Deutsch als Fremdsprache (De-De)
- **Duden** — Das große Wörterbuch (De-De)
- **Duden** — Synonyme (De-De)
- **Duden** — Etymologie (De-De)
- **Universal** — De-Ru, Ru-De

## Немецкое склонение слов

По умолчанию Yomitan ищет точные совпадения в словаре. Для немецкого это означает, что если у вас есть статья для слова "laufen", но вы ищете "lief" или "gelaufen", Yomitan не найдёт её.

Мы предоставляем пользовательский файл `german-transforms.js` в папке `yomitan-de-language/`, который добавляет правила деинфлексии для немецких слов:

- **Глаголы**: "lief" → "laufen", "gelaufen" → "laufen"
- **Существительные**: "Männer" → "Mann", "Tische" → "Tisch"
- **Прилагательные**: "schnellste" → "schnell"
- **Умлауты**: "Bäume" → "Baume"

### Установка

Скопируйте `yomitan-de-language/german-transforms.js` в папку вашего расширения Yomitan:
- **Chrome**: `chrome-extension_[ID]/js/language/de/german-transforms.js`
- **Firefox**: `moz-extension_[ID]/js/language/de/german-transforms.js`

Перезапустите Yomitan и ищите изменённые формы немецких слов — теперь они должны находить свои словарные формы.

**Примечание:** Это решение, созданное сообществом. Правила могут охватывать не все формы немецких слов. Не стесняйтесь улучшать его!

Подробные инструкции см. в `yomitan-de-language/README.md`.

## Структура проекта

```
.
├── main.py                  # Точка входа CLI
├── src/
│   ├── parser.py            # Чтение и извлечение статей из DSL
│   ├── converter.py         # Преобразование тегов DSL в JSON Yomitan
│   ├── packer.py            # Создание ZIP-архива
│   ├── tag_map.py           # Определения тегов DSL и регулярные выражения
│   └── exceptions.py        # Пользовательские исключения
├── data/
│   └── styles.css           # Таблица стилей для немецких словарей
├── yomitan-de-language/
│   ├── german-transforms.js # Деинфлексия немецких слов для Yomitan
│   └── README.md            # Инструкция по установке
├── tests/
│   ├── test_parser.py
│   ├── test_converter.py
│   └── test_packer.py
└── requirements.txt
```

## Лицензия

MIT License — подробности в файле LICENSE.

## Автор

Евгений Ерошев (GitHub: @acheronex)
